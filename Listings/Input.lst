C51 COMPILER V9.56.0.0   INPUT                                                             11/10/2017 09:15:03 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE INPUT
OBJECT MODULE PLACED IN Input.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Input.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(C:\Keil_v5\C51\INC\SiLABS\s
                    -hared\si8051Base) DEBUG PRINT(.\Listings\Input.lst) TABS(2)

line level    source

   1          #include  <REG_MPC89L51-515.h>
   2          #include  "CPLD.h"
   3          #include  "Input.h"
   4          #include  "delay.h"
   5          #include  "LCM.h"
   6          #include  "error.h"
   7          
   8          
   9          /** input pin **/
  10          unsigned char xdata INS000     _at_ 0xc000; //inputÁöÑË≥áÊñôÊö´Â≠òÂô®
  11          
  12          
  13          /** input Ë≥áÊñôÊö´Â≠òËÆäÊï∏ **/
  14          typedef idata struct  {
  15            unsigned char kss3;
  16            unsigned char kss4;
  17            unsigned char kss5;
  18            unsigned char kss6; 
  19          }INPUT;
  20          INPUT my_input;
  21          
  22          
  23          /** input Êö´Â≠òËÆäÊï∏ÂàùÂßãÂåñ **/
  24          void Input_Variable_Init(void)  {
  25   1      
  26   1            my_input.kss3 = 0;
  27   1            my_input.kss4 = 0;
  28   1            my_input.kss5 = 0;
  29   1            my_input.kss6 = 0;
  30   1      }
  31          
  32          
  33          /**  IO Ëá¥ËÉΩ  **/
  34          void Enable_Pin(unsigned char Enable_name)  {
  35   1          
  36   1        switch(Enable_name) {
  37   2          
  38   2          case COIN_1:    cpld_out(0x86,1);   break;
  39   2          case METER_CS:    cpld_out(0x87,1);   break;
  40   2          case METER_A:   cpld_out(0x70,1);   break; 
  41   2          case METER_B:   cpld_out(0x71,1);   break; 
  42   2          case METER_C:   cpld_out(0x72,1);   break; 
  43   2          
  44   2        }
  45   1      }//Enable END
  46          
  47          /**  IO Á¶ÅËÉΩ  **/
  48          void Disable_Pin(unsigned char Disable_name) {
  49   1      
  50   1        switch(Disable_name) {
  51   2        
  52   2          case COIN_1:    cpld_out(0x86,0);   break;
  53   2          case METER_CS:    cpld_out(0x87,0);   break;
  54   2          case METER_A:   cpld_out(0x70,0);   break; 
C51 COMPILER V9.56.0.0   INPUT                                                             11/10/2017 09:15:03 PAGE 2   

  55   2          case METER_B:   cpld_out(0x71,0);   break; 
  56   2          case METER_C:   cpld_out(0x72,0);   break; 
  57   2        }
  58   1      
  59   1      }//Disable END
  60          /** input ËÖ≥‰ΩçÈáçÊñ∞ÂëΩÂêç(Êñπ‰æøËæ®Ë≠ò) **/
  61          bit Read_Data_from(unsigned char Pin_name)  {
  62   1        
  63   1        switch(Pin_name)  {
  64   2          case  COIN_1:   return P32;   break;    //JP2 Á¨¨2ËÖ≥
  65   2        }
  66   1      
  67   1      }
  68          
  69          /**   ÊåâÈàïÈñãÈóú   **/
  70          /*- Pin_nameÔºöËº∏ÂÖ•ËÖ≥‰ΩçÂêçÁ®± -*/
  71          bit Input_Pin_Data(unsigned char Pin_name)  {
  72   1      
  73   1        switch(Pin_name) {
  74   2          
  75   2          case HIT1: //Áî±Input.hÂÖßÂÆ£Âëä‰ª£Ëôü
  76   2            
  77   2              cpld_out(0x63,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x63ÁÇ∫KSS3 
  78   2              
  79   2              my_input.kss3 = INS000; //Â∞áË≥áÊñôÊö´Â≠òÂô®INSË≥áÊñôÊîæÂà∞Êö´Â≠òËÆäÊï∏ my_cpld.kss3 ÂÖßÂÑ≤Â≠ò
  80   2              
  81   2              //Â¶ÇÊûúÈñãÈóúÊåâ‰∏ãÂæåÂü∑Ë°åÁöÑÂãï‰ΩúË∂ÖÈÅéÂΩàË∑≥ÊôÇÈñìÔºåÂâá‰∏çÈúÄË¶ÅÈò≤ÂΩàË∑≥
  82   2              if( (my_input.kss3 & 0x20) == 0 )   delay1ms(20); //Èò≤ÂΩàË∑≥(debouncer)ÔºåÈúÄÂª∂ÈÅ≤20ms
  83   2                
  84   2              return (my_input.kss3 & 0x20);  /***  Âè™ÈúÄË¶ÅHIT1ËÖ≥‰ΩçË≥áÊñô (Áï∂ÈñãÈóúONÊôÇreturn 0ÔºåÈñãÈóúOFFÊôÇre
             -turn 1)  ***/
  85   2              /*    INSËÖ≥‰ΩçÊúÉ‰∏ÄÊ¨°ËÆÄÂèñkss3ÊâÄÊúâËº∏ÂÖ•ÁöÑÁãÄÊÖãÔºåAND 0X20Âç≥ÂèØÈáùÂ∞çHIT1ËÖ≥‰ΩçÊòØÂê¶ÊúâË®äËôüË
             -º∏ÂÖ•    */
  86   2          break;
  87   2              
  88   2          case GOOD2: //Áî±Input.hÂÖßÂÆ£Âëä‰ª£Ëôü
  89   2            
  90   2              cpld_out(0x64,1);
  91   2          
  92   2              my_input.kss4 = INS000; 
  93   2          
  94   2              if( (my_input.kss4 & 0x08) == 0 )   delay1ms(20);
  95   2          
  96   2              return (my_input.kss4 & 0x08); /*** Âè™ÈúÄË¶ÅÂèñÂæó GOOD2 ËÖ≥‰ΩçË≥áÊñô  ***/
  97   2          break;
  98   2          
  99   2          case METER_A:  //ÈõªÂ≠êÁ¢ºÈå∂ÔºåÊñ∑Á∑öÊ™¢Áü•
 100   2          
 101   2              //ÈúÄ‰ΩøÁî®"Enable_Pin(METER_CS)"ÂáΩÂºèËá¥ËÉΩÈõªÂ≠êÁ¢ºÈå∂
 102   2          
 103   2              cpld_out(0x66,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x66ÁÇ∫KSS6
 104   2                
 105   2              //delay1ms(20);
 106   2              my_input.kss6 = INS000; 
 107   2          
 108   2              return (my_input.kss6 & 0x20); /***ÂèñÂæó  RD5 ËÖ≥‰ΩçË≥áÊñô ***/
 109   2          break;
 110   2          
 111   2          case METER_B: 
 112   2              
 113   2              cpld_out(0x66,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x66ÁÇ∫KSS6
 114   2              
C51 COMPILER V9.56.0.0   INPUT                                                             11/10/2017 09:15:03 PAGE 3   

 115   2              my_input.kss6 = INS000; 
 116   2          
 117   2              return (my_input.kss6 & 0x40);/***ÂèñÂæó  RD6 ËÖ≥‰ΩçË≥áÊñô  ***/
 118   2          break;
 119   2              
 120   2          case METER_C:
 121   2              
 122   2              cpld_out(0x66,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x66ÁÇ∫KSS6
 123   2              
 124   2              my_input.kss6 = INS000; 
 125   2          
 126   2              return (my_input.kss6 & 0x80);/***ÂèñÂæó  RD7 ËÖ≥‰ΩçË≥áÊñô  ***/
 127   2          break;
 128   2          
 129   2          case JP5_PT1: //test:ÈõªÁúºËÖ≥‰Ωç
 130   2            
 131   2              cpld_out(0x63,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x63ÁÇ∫KSS3 
 132   2              
 133   2              my_input.kss3 = INS000; 
 134   2              
 135   2              //Â¶ÇÊûúÈñãÈóúÊåâ‰∏ãÂæåÂü∑Ë°åÁöÑÂãï‰ΩúË∂ÖÈÅéÂΩàË∑≥ÊôÇÈñìÔºåÂâá‰∏çÈúÄË¶ÅÈò≤ÂΩàË∑≥
 136   2              if( (my_input.kss3 & 0x01) == 0 )   delay1ms(20); //Èò≤ÂΩàË∑≥(debouncer)ÔºåÈúÄÂª∂ÈÅ≤20ms
 137   2                
 138   2              return (my_input.kss3 & 0x01);
 139   2          break;
 140   2          
 141   2          case JP5_GOOD1: //test:ËøëÊé•ÈñãÈóúËÖ≥‰Ωç (NPNÂûã 0:ON(Âê∏Á£Å) 1:OFF )
 142   2            
 143   2              cpld_out(0x64,1); //InputËá¥ËÉΩËÖ≥‰ΩçÈÅ∏ÊìáÔºå0x63ÁÇ∫KSS4 
 144   2              
 145   2              my_input.kss4 = INS000; 
 146   2              
 147   2              //Â¶ÇÊûúÈñãÈóúÊåâ‰∏ãÂæåÂü∑Ë°åÁöÑÂãï‰ΩúË∂ÖÈÅéÂΩàË∑≥ÊôÇÈñìÔºåÂâá‰∏çÈúÄË¶ÅÈò≤ÂΩàË∑≥
 148   2              if( (my_input.kss4 & 0x01) == 0 )   delay1ms(20); //Èò≤ÂΩàË∑≥(debouncer)ÔºåÈúÄÂª∂ÈÅ≤20ms
 149   2                
 150   2              return (my_input.kss4 & 0x04);/***ÂèñÂæó GOOD1_RD2 ËÖ≥‰ΩçË≥áÊñô ***/
 151   2          break;
 152   2      
 153   2        }
 154   1        
 155   1        return -1;
 156   1      }
 157          
 158          
 159          /**   ÊäïÂπ£Ê©ü  **/
 160          bit Coin_Function(void) {
 161   1        
 162   1        static unsigned int Coin_Timer = 0; //Èò≤Èá£È≠öË®àÊï∏(1ms)
 163   1        static unsigned char Coin_Flag = 0; //ÊòØÂê¶ÊäïÂπ£(0:ÁÑ°  1:Êúâ)
 164   1      
 165   1        if( Read_Data_from(COIN_1)  == 0  ) {
 166   2          Coin_Timer++; //Áï∂ÊäïÂπ£Ê©üÊúâË®äËôü(0Ë°®Á§∫ÊúâÁ°¨Âπ£ÊäïÂÖ•)ÔºåÂâáÈñãÂßãË®àÊï∏ËÑàË°ùË®äËôüÊåÅÁ∫åÊôÇÈñì
 167   2        }
 168   1        else  {
 169   2            if( Coin_Timer  >=  5  &&  Coin_Timer <=  150 ) {
 170   3                  Coin_Flag = 1;  //Â¶ÇÊûúËÑàË°ùË®äËôü‰ªãÊñº5~150ms‰πãÈñìÂâáË°®Á§∫ÁÑ°Èá£È≠öÔºåCoin_FlagÁÇ∫1
 171   3                  Coin_Timer = 0; //ÈáçÁΩÆËÑàÊ≥¢Ë®àÊôÇËÆäÊï∏ÔºåÁ≠âÂæÖ‰∏ã‰∏ÄÊ¨°ÊäïÂπ£ËÑàÊ≥¢ÂÅµÊ∏¨
 172   3            }
 173   2            //ÂÅµÊ∏¨Âà∞Èá£È≠ö-Á¶ÅËÉΩ
 174   2            else if ( Coin_Timer  > 150 ) { 
 175   3              Disable_Pin(COIN_1);//ÊäïÂπ£Âô®Á¶ÅËÉΩ
 176   3              Coin_Timer = 0;
C51 COMPILER V9.56.0.0   INPUT                                                             11/10/2017 09:15:03 PAGE 4   

 177   3              return -1;
 178   3            }
 179   2        }
 180   1      
 181   1        // Coin_Flag==1 : ÂÅµÊ∏¨Âà∞ÊäïÂπ£
 182   1        if( Coin_Flag == 1  ) {
 183   2          Coin_Flag = 0;
 184   2          return 1;
 185   2        }
 186   1        
 187   1        return 0;
 188   1      }
 189          
 190          bit Meter_ADD(char *Meter_A, char *Meter_B, char *Meter_C) {
 191   1      
 192   1        static char idata MeterTimer = 0;  //Á¢ºÈå∂ËÑàÊ≥¢Ë®àÊï∏
 193   1        
 194   1         if( MeterTimer == 0 ) {
 195   2          
 196   2           //Ê™¢Êü•ÈõªÂ≠êÁ¢ºÈå∂ÈÄ£Êé•ÁãÄÊÖã
 197   2           Meter_Online_Check();
 198   2           
 199   2           //Â¶ÇÊûú Meter_ ËÆäÊï∏Â§ßÊñº0ÔºåÂâáÂ∞áÈõªÂ≠êÁ¢ºÈå∂Êãâ High Ôºå‰∏¶ÈñãÂßãË®àÊï∏
 200   2           //ÈõªÂ≠êÁ¢ºÈå∂Âè™Ë¶ÅÊãâ High ‰∏ÄÊ¨°Âç≥ÂèØÁ≠âÂæÖ LOW ÁãÄÊÖãÂà∞‰æÜÔºåÁãÄÊÖã‰∏ÄÊ¨°High„ÄÅLowÈõªÂ≠êÁ¢ºÈå∂Âä
             -†1
 201   2          if( *Meter_A > 0 )  Enable_Pin(METER_A);
 202   2          if( *Meter_B > 0 )  Enable_Pin(METER_B);
 203   2          if( *Meter_C > 0 )  Enable_Pin(METER_C);
 204   2         }
 205   1         
 206   1         MeterTimer++;
 207   1         
 208   1         //Áï∂HighÁãÄÊÖãÊåÅÁ∫å30msÂâáÁãÄÊÖãÊîπLOW (Interrupt 1ms ÂÅµÊ∏¨‰∏ÄÊ¨°)
 209   1         if( MeterTimer == 30 ) {
 210   2             //ÂÅµÊ∏¨ÈõªÂ≠êÁ¢ºÈå∂ÈÄ£Êé•ÁãÄÊÖãÔºåÂ¶ÇÊûúÈÄ£ÁµêÁãÄÊÖãÊ≤íÂïèÈ°åÔºåÂâáÂ∞á Meter_ ËÆäÊï∏Ê∏õ1
 211   2             //Â¶ÇÊûú Meter_ ËÆäÊï∏Ë®≠ÂÆöÁÇ∫2ÔºåÊ∏õ1‰πãÂæåËÆäÊï∏ÁÇ∫1ÔºåÂâáËÑàÊ≥¢ÂâáÊúÉÂÜçHight„ÄÅLow‰∏ÄÊ¨° (Ê≠§ÊÆµÁ
             -®ãÂºèÁÇ∫ÈõªÂ≠êÁ¢ºÈå∂+2ÂäüËÉΩ)
 212   2            if( Input_Pin_Data(METER_A) ) *Meter_A-=1;
 213   2            if( Input_Pin_Data(METER_B) ) *Meter_B-=1;
 214   2            if( Input_Pin_Data(METER_C) ) *Meter_C-=1;
 215   2           
 216   2             //ÁãÄÊÖãÊãâLOW
 217   2            Disable_Pin(METER_A);
 218   2            Disable_Pin(METER_B);
 219   2            Disable_Pin(METER_C);
 220   2         }
 221   1         
 222   1         //ËÑàÊ≥¢‰∏ÄÊ¨°ÊôÇÈñìÔºö60ms (HighÔºö30ms + LOW 30ms)
 223   1         //60msÁµêÊùüÊâçÊúÉÈÄÅ‰∏ã‰∏ÄÊ¨°ËÑàÊ≥¢(ÂèØÈÅøÂÖçÈõªÂ≠êÁ¢ºÈå∂Âõ†ËÑàÊ≥¢High„ÄÅLowÂ§™Âø´ÂÅµÊ∏¨ÈåØË™§)
 224   1         if( MeterTimer > 60 ) {
 225   2             MeterTimer=0;
 226   2             return 1;
 227   2         }
 228   1         
 229   1         return -1;
 230   1      }
 231          
 232          void Meter_Online_Check(void) {
 233   1        
 234   1        //Áï∂ÈõªÂ≠êÁ¢ºÈå∂ÔºåÈÅ≠ÊãîÈô§ÔºåÂâáÊúÉÂõûÂÇ≥Ë©≤ËÖ≥‰Ωç"Input_Pin_Data()"ÁöÑÂÄºÔºö
 235   1        //ConnectÔºöÂõûÂÇ≥"0"„ÄÅDisconnectÔºöÂõûÂÇ≥"1"„ÄÇ(ÂíåÊåâÈàïÈñãÈóúÁõ∏Âêå)
 236   1        
C51 COMPILER V9.56.0.0   INPUT                                                             11/10/2017 09:15:03 PAGE 5   

 237   1          if( Input_Pin_Data(METER_A) == 1 || Input_Pin_Data(METER_B) == 1 || Input_Pin_Data(METER_C) ==1 ) {
 238   2              cpld_out(0xB3,1); //LED‰∫Æ
 239   2          }
 240   1        
 241   1      
 242   1      }
*** WARNING C291 IN LINE 67 OF Input.c: not every exit path returns a value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    598    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3       9
   IDATA SIZE       =      5    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)

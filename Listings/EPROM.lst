C51 COMPILER V9.56.0.0   EPROM                                                             11/10/2017 09:15:03 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE EPROM
OBJECT MODULE PLACED IN EPROM.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE EPROM.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(C:\Keil_v5\C51\INC\SiLABS\s
                    -hared\si8051Base) DEBUG PRINT(.\Listings\EPROM.lst) TABS(2)

line level    source

   1          #include <REG_MPC89L51-515.h>
   2          #include <INTRINS.H>  // _nop_ åŠŸèƒ½ï¼šæš«åœä¸€å€‹CPUçš„é€±æœŸæ™‚é–“ 
   3          
   4          #include "EPROM.h"
   5          #include "LCM.h"
   6          
   7          /** EPROM å‹è™Ÿï¼šFM25C160ds 
   8          /** å®¹é‡ï¼š2048 * 8 bits (000~7FFH * ä¸€æ¬¡å¯è¼¸å…¥8 bitsè³‡æ–™é‡)
   9          **/
  10          
  11          /** -----EPROM SPI----- **/
  12          unsigned char SPI_i;    //å…±ç”¨çš„iï¼Œçµ•ä¸èƒ½å¹³å¸¸å‘¼å«ï¼Œä¸­æ–·åˆå‘¼å«
  13          
  14          void EPROM_Writ_SPI(unsigned char Op_code) {
  15   1        
  16   1        for( SPI_i = 0; SPI_i <= 7; SPI_i++ ) {
  17   2          
  18   2          SI = 0; //å¯«å…¥0
  19   2          //ä¸€æ¬¡è¼¸å…¥ä¸€å€‹ä½å…ƒï¼Œåˆ©ç”¨ANDä¿ç•™è¼¸å…¥è³‡æ–™çš„å…¶ä¸­ä¸€å€‹ä½å…ƒè³‡æ–™
  20   2          if( ( Op_code & ( 0x80 >> SPI_i ) ) != 0 )  SI = 1; //å¯«å…¥1
  21   2            
  22   2          CLK = 1; //Clockï¼šæ‰“ä¸€å€‹æ™‚è„ˆï¼Œè¡¨ç¤ºæœ‰ä¸€å€‹ä½å…ƒè³‡æ–™è¦è¼¸å…¥
  23   2          CLK = 0;
  24   2        }
  25   1        
  26   1        SI = 0;
  27   1      }
  28          
  29          unsigned char EPROM_Read_SPI(void) {
  30   1        
  31   1        unsigned char Data = 0;
  32   1        
  33   1        for( SPI_i = 0; SPI_i <= 7; SPI_i++ ) {
  34   2          
  35   2          CLK = 1; //è®€ç•¶å‰æ™‚è„ˆçš„è³‡æ–™ï¼Œèˆ‡å¯«å…¥è³‡æ–™ä¸åŒï¼Œè®€å–æ™‚å¿…é ˆåœ¨æ™‚è„ˆç‚ºé«˜é›»ä½æ™‚è®€
             -å–
  36   2          
  37   2            if( SO != 0 ) Data++; //+1ï¼ŒSOç‚ºEPROMè¼¸å‡ºè…³
  38   2          
  39   2          CLK = 0;
  40   2          
  41   2            if(SPI_i < 7) Data <<= 1; //å°‡Dataè³‡æ–™å…¨éƒ¨å·¦ç§» 1bit (æœ€å¾Œç¸½å…±å‘å·¦ç§»å‹•8 bits)
  42   2        
  43   2        }
  44   1        return Data;  
  45   1      }
  46          
  47          /** -----EPROM Writ----- **/
  48          //**å‡½å¼åˆ†ç‚ºå…©ç¨®åŠŸèƒ½ï¼š
  49          //**  1. ä¸€æ¬¡å¯«å…¥1å€‹bytes(8 bits)  : char 
  50          //**  2. ä¸€æ¬¡å¯«å…¥2å€‹bytes(16 bits) : int
  51          
  52          void EPROM_Writ_Data8(unsigned int address,unsigned char Data) {  //unsigned charç‚º8bits
  53   1        EA = 0; //8051å®šç¾©è…³ä½ï¼š0è¡¨ç¤º-ç¦æ­¢æ‰€æœ‰ä¸­æ–·åŠŸèƒ½ã€1è¡¨ç¤º-å•Ÿç”¨ä¸­æ–·åŠŸèƒ½
C51 COMPILER V9.56.0.0   EPROM                                                             11/10/2017 09:15:03 PAGE 2   

  54   1        CS = 0; //EPROMè‡´èƒ½è…³ (ä½æº–ä½æ™ºèƒ½)
  55   1        EPROM_Writ_SPI( 0x06 ); //EPROM Op-codeé–‹å•Ÿ/é—œé–‰å¯«å…¥åŠŸèƒ½ ("0x06" Set Write Enableã€"0x04" Write 
             -Disable)
  56   1        CS = 1;
  57   1        
  58   1        _nop_();
  59   1        //_nop_();
  60   1        
  61   1        CS = 0;
  62   1        EPROM_Writ_SPI( 0x02 ); //EPROM Op-code(Write memory data)å¯«å…¥è³‡æ–™æŒ‡ä»¤
  63   1        
  64   1        //è³‡æ–™å¯«å…¥ï¼šä½å€æŒ‡å®š
  65   1        //ä½å€æœ‰ 2 Bytes (ex. 0x0234)
  66   1        EPROM_Writ_SPI( address >> 8 );     //ç¬¬ä¸€æ¬¡å¯«å…¥è³‡æ–™ç‚ºï¼š0x02 
  67   1        EPROM_Writ_SPI( address & 0x00ff ); //ç¬¬äºŒæ¬¡å¯«å…¥è³‡æ–™ç‚ºï¼š0x34
  68   1        
  69   1        //å¯«å…¥è¦å„²å­˜çš„å…§å®¹
  70   1        EPROM_Writ_SPI( Data );
  71   1        
  72   1        CS = 1;
  73   1        EA = 1;
  74   1      } 
  75          
  76          void EPROM_Writ_Data16(unsigned int address,unsigned int Data) {  //unsigned intç‚º16bits
  77   1        EA = 0;
  78   1        CS = 0;
  79   1        EPROM_Writ_SPI( 0x06 );
  80   1        CS = 1;
  81   1        
  82   1        _nop_();
  83   1        _nop_();
  84   1        
  85   1        CS = 0;
  86   1      
  87   1        EPROM_Writ_SPI( 0x02 );
  88   1        EPROM_Writ_SPI( address >> 8 );
  89   1        EPROM_Writ_SPI( address & 0x00ff );
  90   1        
  91   1        //å¯«å…¥ç¬¬äºŒæ¬¡è³‡æ–™æ™‚ï¼Œæœƒè‡ªå‹•æ›åˆ°ä¸‹ä¸€å€‹ä½å€å„²å­˜(åªè¦CSæ²’æœ‰ç‚º0)
  92   1        EPROM_Writ_SPI( Data >> 8 );    
  93   1        EPROM_Writ_SPI( Data & 0x00ff );
  94   1        
  95   1        CS = 1;
  96   1        EA = 1;
  97   1      }
  98          
  99          /** -----EPROM Read----- **/
 100          unsigned int R_Data;
 101          
 102          unsigned char EPROM_Read_Data8(unsigned int address) {  
 103   1      
 104   1        EA = 0;
 105   1        CS = 0;
 106   1        EPROM_Writ_SPI( 0x03 ); //EPROM Op-code(Read Memory Data) è®€å–è³‡æ–™æŒ‡ä»¤
 107   1        
 108   1        //å¯«å…¥éœ€è®€å–çš„ä½å€
 109   1        EPROM_Writ_SPI( address >> 8 );   
 110   1        EPROM_Writ_SPI( address & 0x00ff );
 111   1        
 112   1        //å–å¾—å¯«å…¥ä½å€çš„è³‡æ–™
 113   1        R_Data = EPROM_Read_SPI(); 
 114   1        CS = 1; 
C51 COMPILER V9.56.0.0   EPROM                                                             11/10/2017 09:15:03 PAGE 3   

 115   1        EA = 1;
 116   1        return R_Data;
 117   1      }
 118          
 119          unsigned int EPROM_Read_Data16(unsigned int address)  {
 120   1        
 121   1        EA = 0;
 122   1        CS = 0;
 123   1        EPROM_Writ_SPI( 0x03 );
 124   1        EPROM_Writ_SPI( address >> 8 );
 125   1        EPROM_Writ_SPI( address & 0x00ff );
 126   1        
 127   1        R_Data = EPROM_Read_SPI();
 128   1        R_Data <<= 8;
 129   1        R_Data += EPROM_Read_SPI();
 130   1        CS = 1;
 131   1        EA = 1;
 132   1        return R_Data;
 133   1        
 134   1      }
 135          
 136          /** -----EPROM Function----- **/
 137          void EPROM_Test(void) {
 138   1        
 139   1        unsigned short Test_address=0, Test_Record=0;//Test_address : æŒ‡å®šEPROMçš„ä½å€ã€Test_Record : ç´€éŒ„
             -EPROMä½å€è£¡çš„æ•¸å€¼
 140   1        
 141   1        //EPROMç¸½å®¹é‡ 2048 * 8bits (2048=0x0800)
 142   1        for(Test_address = 0x000; Test_address < 0x800; Test_address++) {
 143   2          
 144   2            //è®€å–EPROMä½å€è³‡æ–™ï¼Œä¸¦ç”±è®Šæ•¸Test_Recordæ‰¿æ¥æ­¤ä½å€è³‡æ–™
 145   2            Test_Record = EPROM_Read_Data8(Test_address);
 146   2          
 147   2          //Step 02:
 148   2              //å¦‚æœè©²ä½å€çš„å€¼åŸæœ¬å°±ç‚º0x55å‰‡:
 149   2            if (Test_Record == 0x55) {
 150   3              
 151   3                //å°‡0xAAå¯«å…¥FTæŒ‡å®šä¹‹ä½å€
 152   3                EPROM_Writ_Data8(Test_address, 0xAA);
 153   3                
 154   3                //æ¥è‘—è®€å–FTæŒ‡å®šä½å€ä¹‹è³‡æ–™ï¼Œåˆ¤æ–·æ˜¯å¦ç‚º0xAAï¼Œå¦‚æœä¸æ˜¯ï¼Œè¡¨ç¤ºEPROMå¯«å…¥æ•…éšœï
             -¼ŒLCMé¡¯ç¤ºæ•…éšœæç¤º
 155   3                if (EPROM_Read_Data8(Test_address) != 0xAA)   LCM_Print_Char_Function(4,"ERPOM ERROR");
 156   3                
 157   3                //æ¸¬è©¦å®ŒEPROMå¾Œï¼Œå›å¾© EPROM åŸæœ¬çš„è³‡æ–™
 158   3                EPROM_Writ_Data8(Test_address, Test_Record);     
 159   3            }
 160   2          //Step 01:
 161   2            else {
 162   3                //å°‡0x55å¯«å…¥æŒ‡å®šä½å€(Test_address)
 163   3                EPROM_Writ_Data8(Test_address, 0x55);
 164   3                
 165   3                //æ¥è‘—è®€å–(Test_address)ä½å€ä¹‹è³‡æ–™ï¼Œåˆ¤æ–·æ˜¯å¦ç‚º0x55ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¡¨ç¤ºEPROMå¯«å…¥æ
             -•…éšœï¼ŒLCMé¡¯ç¤ºæ•…éšœæç¤º
 166   3                if (EPROM_Read_Data8(Test_address) != 0x55)   LCM_Print_Char_Function(4,"ERPOM ERROR");
 167   3                
 168   3                //æ¸¬è©¦å®ŒEPROMå¾Œï¼Œå›å¾© EPROM åŸæœ¬çš„è³‡æ–™
 169   3                EPROM_Writ_Data8(Test_address, Test_Record);  
 170   3            }
 171   2        }
 172   1        
 173   1        LCM_Print_Char_Function(4,"ERPOM GOOD");
C51 COMPILER V9.56.0.0   EPROM                                                             11/10/2017 09:15:03 PAGE 4   

 174   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    394    ----
   CONSTANT SIZE    =     23    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
